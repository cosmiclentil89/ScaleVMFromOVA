# VM Import from OVA

A **Go** command-line tool that streamlines the end-to-end refresh and re-import of virtual-machine images exported from a **Scale Computing HC3** cluster as OVA files.  
It automatically copies disk images, rewrites the `scale-metadata` XML, and queues the VM import through HC3’s REST API—turning a multi-step manual procedure into a single command.

---

## ✨ Features

| Step | What the tool does | Why it matters |
|------|--------------------|----------------|
| 1️⃣  | **Delete existing `.qcow2`** images in your local VM staging folder. | Ensures stale disks don’t linger and avoids import conflicts. |
| 2️⃣  | **Copy VMDK ➜ QCOW2** in place—matching OVF disk order to Scale disk UUIDs. | Preserves correct disk mapping and format expected by HC3. |
| 3️⃣  | **Rewrite `<tags>` block** inside the VM’s Scale XML definition. | Adds a `imported_by_script` tag for auditability; removes any old tag clutter. |
| 4️⃣  | **Optional API import** via HC3 REST (`/rest/v1/VirDomain/import`). | Re-registers the VM on the cluster without visiting the UI. |

---

## 🛠 Prerequisites

* **Go 1.21+** installed  
* Access to a **Scale HC3** node (v9.x or later) with REST API credentials  
* SMB share exported from your HC3 cluster (or reachable file server) that contains:  
  * exported OVA folder (`*.ovf`, `*.vmdk`, etc.)  
  * staging directory with Scale XML and disk UUID sub-folders  
* Operating system with `qemu-img` if you plan to tweak disk conversion manually (script does not invoke it directly)

---

## 📂 Default Directory Layout

```
/data/vms
├── ova/                 # original OVA exports
│   └── centos7/
│       ├── centos7.ovf
│       ├── centos7-disk1.vmdk
│       └── centos7-disk2.vmdk
└── scale/               # working directory for import. VM template should be exported from scale to this dir
    └── centos7/
        ├── centos7.xml
        ├── e0a1...uuid.qcow2   # regenerated by script
        └── 7f2b...uuid.qcow2   # ...
```

You can override these paths with flags (`-ovadir`, `-scaledir`, etc.) if you modify the source.

---

## 🔧 Build

```bash
git clone https://github.com/your-org/vm-import-from-ova.git
cd vm-import-from-ova
go build -o vm-import .
```

*(Or simply run with `go run ./...`.)*

---

## 🚀 Usage

```bash
./vm-import   -api  https://192.168.0.1   -user admin   -pass changeme   -share "smb://WORKGROUP;user:pwd@192.168.0.1/sambashare/"
```

### Interactive flow

1. **Discover**: The tool scans `<OVADir>` for sub-folders containing `*.ovf`.
2. **Prompt**: It lists candidate VM names and waits for you to choose (`all`, `1,3,4` etc.).
3. **Process each VM**: performs Steps 1-4 above.
4. **Confirm import**: For each VM it asks “Import VM via API? (y/N)” unless `-import` is set.

### Non-interactive / CI

```bash
./vm-import -vms "centos7,ubuntu22" -import -n
```

* `-vms` skips the menu.  
* `-import` auto-imports after processing.  
* `-n` enables **dry-run** mode (print actions, no filesystem writes nor API calls).

---

## 🏷️ Command-line Flags

| Flag | Default | Description |
|------|---------|-------------|
| `-vms` | `` | Comma-separated VM names to process (skip prompt). |
| `-import` | `false` | Import VMs automatically without confirmation. |
| `-n` | `false` | Dry-run: log intended actions only. |
| `-api` | `https://192.168.0.1` | Base URL of Scale HC3 REST API. |
| `-user` / `-pass` | `admin` / `admin` | API basic-auth credentials. |
| `-share` | `smb://WORKGROUP;sambauser:pwd@192.168.0.1/sambashare/` | SMB URI prefix where disk folders reside. |

*(Edit the constants in `main.go` or supply flags at runtime.)*

---

## 🔄 Workflow Details

1. **QCOW2 cleanup** – Locates `*.qcow2` under `<ScaleDir>/<vm>/` and removes them.  
2. **OVF parsing** – Reads `<vm>.ovf` and extracts `<File id=\"file1\" href=\"disk-1.vmdk\"/>` order.  
3. **Scale XML parsing** – Reads `<vm>.xml`, grabs each `<disk type=\"network\" device=\"disk\"><source name=\".../UUID\"/>`.  
4. **Copy disks** – Pairs Nth VMDK → Nth UUID, copies to `UUID.qcow2`.  
5. **Tags rewrite** – Replaces any existing `<tags>` block with:

   ```xml
   <tags>
     <tag name="imported_by_script"/>
   </tags>
   ```

6. **REST call** – `POST /VirDomain/import` JSON body:

   ```json
   {
     "source": {
       "pathURI": "smb://.../<vm>",
       "format": "qcow2",
       "definitionFileName": "<vm>.xml",
       "allowNonSequentialWrites": true,
       "parallelCountPerTransfer": 0
     }
   }
   ```

---

## 🐞 Troubleshooting

* **“no valid VM dirs beneath …”** – Verify `<OVADir>` contains at least one sub-folder with a `.ovf` and that a matching `.xml` exists in `<ScaleDir>`.  
* **API error 401/403** – Check credentials and that your HC3 user has _Cluster Admin_ rights.  
* **Mismatched disk count** – Script continues when VMDK vs UUID counts differ, pairing the first _n_; ensure exports are complete.  
* **Stuck import** – Use the HC3 UI’s **Tasks** page to inspect the queued task UUID printed by the script.

---

## 📜 License

MIT © 2025 cosmiclentil89